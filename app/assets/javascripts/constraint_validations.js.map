{"version":3,"file":"constraint_validations.js","sources":["../../javascript/constraint_validations/index.js"],"sourcesContent":["export default class ConstraintValidations {\n  static connect(element = document, options = {}) {\n    new this(element, options).connect()\n  }\n\n  constructor(element = document, options = {}) {\n    this.element = element\n    this.options = options\n  }\n\n  connect() {\n    this.element.addEventListener(\"invalid\", this.reportFieldValidity, { capture: true, passive: false })\n    this.element.addEventListener(\"blur\", this.clearAndReportFieldValidity, { capture: true, passive: true })\n    this.element.addEventListener(\"input\", this.toggleSubmitsDisabled)\n\n    this.reportValidationMessages()\n  }\n\n  disconnect() {\n    this.element.removeEventListener(\"invalid\", this.reportFieldValidity)\n    this.element.removeEventListener(\"blur\", this.clearAndReportFieldValidity)\n    this.element.removeEventListener(\"input\", this.toggleSubmitsDisabled)\n  }\n\n  reportFieldValidity = (event) => {\n    if (isFieldElement(event.target) && this.reportValidity(event.target)) {\n      event.preventDefault()\n\n      focusFirstInvalidField(event.target.form || event.target)\n    }\n  }\n\n  clearAndReportFieldValidity = ({ target }) => {\n    if (isFieldElement(target)) {\n      this.clearValidity(target)\n      this.reportValidity(target)\n    }\n  }\n\n  toggleSubmitsDisabled = ({ target }) => {\n    if (isFieldElement(target) && this.willDisableSubmitWhenInvalid(target)) {\n      disableSubmitWhenInvalid(target.form)\n    }\n  }\n\n  reportValidationMessages() {\n    for (const invalidElement of this.element.querySelectorAll(\"[aria-errormessage]\")) {\n      const id = invalidElement.getAttribute(\"aria-errormessage\")\n      const validationMessage = document.getElementById(id)\n\n      if (validationMessage) {\n        invalidElement.setCustomValidity(validationMessage.textContent)\n      }\n    }\n  }\n\n  willDisableSubmitWhenInvalid(target) {\n    return typeof this.options.disableSubmitWhenInvalid === \"function\" ?\n      this.options.disableSubmitWhenInvalid(target) :\n      !!this.options.disableSubmitWhenInvalid\n  }\n\n  clearValidity(input) {\n    input.setCustomValidity(\"\")\n\n    this.reportValidity(input)\n  }\n\n  reportValidity(input) {\n    const id = input.getAttribute(\"aria-errormessage\")\n    const validationMessage = getValidationMessage(input)\n    const element = document.getElementById(id) || createValidationMessageFragment(input.form)\n\n    if (input.form?.noValidate) {\n      return false\n    } else if (id && element) {\n      element.id = id\n      element.innerHTML = validationMessage\n\n      if (validationMessage) {\n        input.setCustomValidity(validationMessage)\n        input.setAttribute(\"aria-describedby\", id)\n        input.setAttribute(\"aria-invalid\", \"true\")\n      } else {\n        input.removeAttribute(\"aria-describedby\")\n        input.removeAttribute(\"aria-invalid\")\n      }\n\n      if (!element.parentElement) {\n        input.insertAdjacentElement(\"afterend\", element)\n      }\n\n      if (input.form && this.willDisableSubmitWhenInvalid(input)) disableSubmitWhenInvalid(input.form)\n\n      return true\n    } else {\n      return false\n    }\n  }\n}\n\nfunction focusFirstInvalidField(element) {\n  let firstInvalidField\n\n  if (element instanceof HTMLFormElement) {\n    for (const field of element.elements) {\n      if (field.validity.valid) {\n        continue\n      } else {\n        firstInvalidField = field\n        break\n      }\n    }\n  } else if (\"validity\" in element && !element.validity.valid) {\n    firstInvalidField = element\n  }\n\n  firstInvalidField?.focus()\n}\n\nfunction disableSubmitWhenInvalid(form) {\n  if (!form || form.noValidate) return\n\n  const isValid = Array.from(form.elements).filter(isFieldElement).every(input => input.validity.valid)\n\n  for (const element of form.elements) {\n    if (element.type == \"submit\") {\n      element.disabled = !isValid\n    }\n  }\n}\n\nfunction createValidationMessageFragment(form) {\n  if (form) {\n    const template = form.querySelector(\"[data-validation-message-template]\")\n\n    return template?.content.children[0].cloneNode()\n  }\n}\n\nfunction getValidationMessage(input) {\n  const validationMessages = Object.entries(readValidationMessages(input))\n\n  const [ _, validationMessage ] = validationMessages.find(([ key ]) => input.validity[key]) || [ null, null ]\n\n  return validationMessage || input.validationMessage\n}\n\nfunction readValidationMessages(input) {\n  try {\n    return JSON.parse(input.getAttribute(\"data-validation-messages\")) || {}\n  } catch(_) {\n    return {}\n  }\n}\n\nfunction isFieldElement(element) {\n  return [ HTMLButtonElement, HTMLInputElement, HTMLObjectElement, HTMLOutputElement, HTMLSelectElement, HTMLTextAreaElement ].some(field => element instanceof field)\n}\n"],"names":["ConstraintValidations","[object Object]","element","document","options","this","connect","addEventListener","reportFieldValidity","capture","passive","clearAndReportFieldValidity","toggleSubmitsDisabled","reportValidationMessages","removeEventListener","event","isFieldElement","target","reportValidity","preventDefault","focusFirstInvalidField","form","clearValidity","willDisableSubmitWhenInvalid","disableSubmitWhenInvalid","invalidElement","querySelectorAll","id","getAttribute","validationMessage","getElementById","setCustomValidity","textContent","input","getValidationMessage","createValidationMessageFragment","noValidate","innerHTML","setAttribute","removeAttribute","parentElement","insertAdjacentElement","firstInvalidField","HTMLFormElement","field","elements","validity","valid","focus","isValid","Array","from","filter","every","type","disabled","template","querySelector","content","children","cloneNode","validationMessages","Object","entries","readValidationMessages","_","find","key","JSON","parse","HTMLButtonElement","HTMLInputElement","HTMLObjectElement","HTMLOutputElement","HTMLSelectElement","HTMLTextAreaElement","some"],"mappings":"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"}
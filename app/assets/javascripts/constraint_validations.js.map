{"version":3,"file":"constraint_validations.js","sources":["../../javascript/constraint_validations/index.js"],"sourcesContent":["export default class ConstraintValidations {\n  static connect(element = document, options = {}) {\n    new this(element, options).connect()\n  }\n\n  constructor(element = document, options = {}) {\n    this.element = element\n    this.options = options\n  }\n\n  connect() {\n    this.element.addEventListener(\"invalid\", this.reportFieldValidity, { capture: true, passive: false })\n    this.element.addEventListener(\"blur\", this.clearAndReportFieldValidity, { capture: true, passive: true })\n    this.element.addEventListener(\"input\", this.toggleSubmitsDisabled)\n\n    this.reportValidationMessages()\n  }\n\n  disconnect() {\n    this.element.removeEventListener(\"invalid\", this.reportFieldValidity)\n    this.element.removeEventListener(\"blur\", this.clearAndReportFieldValidity)\n    this.element.removeEventListener(\"input\", this.toggleSubmitsDisabled)\n  }\n\n  reportFieldValidity = (event) => {\n    if (isFieldElement(event.target)) {\n      this.reportValidity(event.target)\n\n      event.preventDefault()\n    }\n  }\n\n  clearAndReportFieldValidity = ({ target }) => {\n    if (isFieldElement(target)) {\n      this.clearValidity(target)\n      this.reportValidity(target)\n    }\n  }\n\n  toggleSubmitsDisabled = ({ target }) => {\n    if (isFieldElement(target) && this.willDisableSubmitWhenInvalid(target)) {\n      disableSubmitWhenInvalid(target.form)\n    }\n  }\n\n  reportValidationMessages() {\n    for (const invalidElement of this.element.querySelectorAll(\"[aria-errormessage]\")) {\n      const id = invalidElement.getAttribute(\"aria-errormessage\")\n      const validationMessage = document.getElementById(id)\n\n      if (validationMessage) {\n        invalidElement.setCustomValidity(validationMessage.textContent)\n      }\n    }\n  }\n\n  willDisableSubmitWhenInvalid(target) {\n    return typeof this.options.disableSubmitWhenInvalid === \"function\" ?\n      this.options.disableSubmitWhenInvalid(target) :\n      !!this.options.disableSubmitWhenInvalid\n  }\n\n  clearValidity(input) {\n    input.setCustomValidity(\"\")\n\n    this.reportValidity(input)\n  }\n\n  reportValidity(input) {\n    if (input.form?.noValidate) return\n\n    const id = input.getAttribute(\"aria-errormessage\")\n    const validationMessage = getValidationMessage(input)\n    const element = document.getElementById(id) || createValidationMessageFragment(input.form)\n\n    if (id && element) {\n      element.id = id\n      element.innerHTML = validationMessage\n\n      if (validationMessage) {\n        input.setCustomValidity(validationMessage)\n        input.setAttribute(\"aria-describedby\", id)\n        input.setAttribute(\"aria-invalid\", \"true\")\n      } else {\n        input.removeAttribute(\"aria-describedby\")\n        input.removeAttribute(\"aria-invalid\")\n      }\n\n      if (!element.parentElement) {\n        input.insertAdjacentElement(\"afterend\", element)\n      }\n    }\n\n    if (input.form && this.willDisableSubmitWhenInvalid(input)) disableSubmitWhenInvalid(input.form)\n  }\n}\n\nfunction disableSubmitWhenInvalid(form) {\n  if (!form || form.noValidate) return\n\n  const isValid = Array.from(form.elements).filter(isFieldElement).every(input => input.validity.valid)\n\n  for (const element of form.elements) {\n    if (element.type == \"submit\") {\n      element.disabled = !isValid\n    }\n  }\n}\n\nfunction createValidationMessageFragment(form) {\n  if (form) {\n    const template = form.querySelector(\"[data-validation-message-template]\")\n\n    return template?.content.children[0].cloneNode()\n  }\n}\n\nfunction getValidationMessage(input) {\n  const validationMessages = Object.entries(readValidationMessages(input))\n\n  const [ _, validationMessage ] = validationMessages.find(([ key ]) => input.validity[key]) || [ null, null ]\n\n  return validationMessage || input.validationMessage\n}\n\nfunction readValidationMessages(input) {\n  try {\n    return JSON.parse(input.getAttribute(\"data-validation-messages\")) || {}\n  } catch(_) {\n    return {}\n  }\n}\n\nfunction isFieldElement(element) {\n  return [ HTMLButtonElement, HTMLInputElement, HTMLObjectElement, HTMLOutputElement, HTMLSelectElement, HTMLTextAreaElement ].some(field => element instanceof field)\n}\n"],"names":["ConstraintValidations","[object Object]","element","document","options","this","connect","addEventListener","reportFieldValidity","capture","passive","clearAndReportFieldValidity","toggleSubmitsDisabled","reportValidationMessages","removeEventListener","event","isFieldElement","target","reportValidity","preventDefault","clearValidity","willDisableSubmitWhenInvalid","disableSubmitWhenInvalid","form","invalidElement","querySelectorAll","id","getAttribute","validationMessage","getElementById","setCustomValidity","textContent","input","noValidate","getValidationMessage","createValidationMessageFragment","innerHTML","setAttribute","removeAttribute","parentElement","insertAdjacentElement","isValid","Array","from","elements","filter","every","validity","valid","type","disabled","template","querySelector","content","children","cloneNode","validationMessages","Object","entries","readValidationMessages","_","find","key","JSON","parse","HTMLButtonElement","HTMLInputElement","HTMLObjectElement","HTMLOutputElement","HTMLSelectElement","HTMLTextAreaElement","some","field"],"mappings":";;EAAe,MAAMA;IACnBC,eAAeC,UAAUC,UAAUC,UAAU;MAC3C,IAAIC,KAAKH,SAASE,SAASE;;IAG7BL,YAAYC,UAAUC,UAAUC,UAAU;MACxCC,KAAKH,UAAUA;MACfG,KAAKD,UAAUA;;IAGjBH;MACEI,KAAKH,QAAQK,iBAAiB,WAAWF,KAAKG,qBAAqB;QAAEC,SAAS;QAAMC,SAAS;;MAC7FL,KAAKH,QAAQK,iBAAiB,QAAQF,KAAKM,6BAA6B;QAAEF,SAAS;QAAMC,SAAS;;MAClGL,KAAKH,QAAQK,iBAAiB,SAASF,KAAKO;MAE5CP,KAAKQ;;IAGPZ;MACEI,KAAKH,QAAQY,oBAAoB,WAAWT,KAAKG;MACjDH,KAAKH,QAAQY,oBAAoB,QAAQT,KAAKM;MAC9CN,KAAKH,QAAQY,oBAAoB,SAAST,KAAKO;;IAGjDX,oBAAuBc;MACrB,IAAIC,eAAeD,MAAME,SAAS;QAChCZ,KAAKa,eAAeH,MAAME;QAE1BF,MAAMI;;;IAIVlB,4BAA8B,EAAGgB,QAAAA;MAC/B,IAAID,eAAeC,SAAS;QAC1BZ,KAAKe,cAAcH;QACnBZ,KAAKa,eAAeD;;;IAIxBhB,sBAAwB,EAAGgB,QAAAA;MACzB,IAAID,eAAeC,WAAWZ,KAAKgB,6BAA6BJ,SAAS;QACvEK,yBAAyBL,OAAOM;;;IAIpCtB;MACE,KAAK,MAAMuB,kBAAkBnB,KAAKH,QAAQuB,iBAAiB,wBAAwB;QACjF,MAAMC,KAAKF,eAAeG,aAAa;QACvC,MAAMC,oBAAoBzB,SAAS0B,eAAeH;QAElD,IAAIE,mBAAmB;UACrBJ,eAAeM,kBAAkBF,kBAAkBG;;;;IAKzD9B,6BAA6BgB;MAC3B,cAAcZ,KAAKD,QAAQkB,6BAA6B,aACtDjB,KAAKD,QAAQkB,yBAAyBL,YACpCZ,KAAKD,QAAQkB;;IAGnBrB,cAAc+B;MACZA,MAAMF,kBAAkB;MAExBzB,KAAKa,eAAec;;IAGtB/B,eAAe+B;MACb,IAAIA,MAAMT,MAAMU,YAAY;MAE5B,MAAMP,KAAKM,MAAML,aAAa;MAC9B,MAAMC,oBAAoBM,qBAAqBF;MAC/C,MAAM9B,UAAUC,SAAS0B,eAAeH,OAAOS,gCAAgCH,MAAMT;MAErF,IAAIG,MAAMxB,SAAS;QACjBA,QAAQwB,KAAKA;QACbxB,QAAQkC,YAAYR;QAEpB,IAAIA,mBAAmB;UACrBI,MAAMF,kBAAkBF;UACxBI,MAAMK,aAAa,oBAAoBX;UACvCM,MAAMK,aAAa,gBAAgB;eAC9B;UACLL,MAAMM,gBAAgB;UACtBN,MAAMM,gBAAgB;;QAGxB,KAAKpC,QAAQqC,eAAe;UAC1BP,MAAMQ,sBAAsB,YAAYtC;;;MAI5C,IAAI8B,MAAMT,QAAQlB,KAAKgB,6BAA6BW,QAAQV,yBAAyBU,MAAMT;;;EAI/F,SAASD,yBAAyBC;IAChC,KAAKA,QAAQA,KAAKU,YAAY;IAE9B,MAAMQ,UAAUC,MAAMC,KAAKpB,KAAKqB,UAAUC,OAAO7B,gBAAgB8B,OAAMd,SAASA,MAAMe,SAASC;IAE/F,KAAK,MAAM9C,WAAWqB,KAAKqB,UAAU;MACnC,IAAI1C,QAAQ+C,QAAQ,UAAU;QAC5B/C,QAAQgD,YAAYT;;;;EAK1B,SAASN,gCAAgCZ;IACvC,IAAIA,MAAM;MACR,MAAM4B,WAAW5B,KAAK6B,cAAc;MAEpC,OAAOD,UAAUE,QAAQC,SAAS,GAAGC;;;EAIzC,SAASrB,qBAAqBF;IAC5B,MAAMwB,qBAAqBC,OAAOC,QAAQC,uBAAuB3B;IAEjE,OAAQ4B,GAAGhC,qBAAsB4B,mBAAmBK,MAAK,EAAGC,SAAU9B,MAAMe,SAASe,UAAS,EAAE,MAAM;IAEtG,OAAOlC,qBAAqBI,MAAMJ;;EAGpC,SAAS+B,uBAAuB3B;IAC9B;MACE,OAAO+B,KAAKC,MAAMhC,MAAML,aAAa,gCAAgC;MACrE,OAAMiC;MACN,OAAO;;;EAIX,SAAS5C,eAAed;IACtB,OAAO,EAAE+D,mBAAmBC,kBAAkBC,mBAAmBC,mBAAmBC,mBAAmBC,sBAAsBC,MAAKC,SAAStE,mBAAmBsE;;;"}